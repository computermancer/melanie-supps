<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Support Guide App</title>
  <script>
    // Service Worker Registration with Enhanced Update Handling
    if ('serviceWorker' in navigator) {
      // First, unregister any existing service workers
      navigator.serviceWorker.getRegistrations().then(registrations => {
        console.log('Unregistering all service workers...');
        return Promise.all(registrations.map(reg => reg.unregister()));
      })
      .then(() => {
        // Clear all caches
        if ('caches' in window) {
          return caches.keys().then(cacheNames => {
            console.log('Deleting caches:', cacheNames);
            return Promise.all(cacheNames.map(cacheName => caches.delete(cacheName)));
          });
        }
      })
      .then(() => {
        // Register the new service worker
        console.log('Registering new service worker...');
        return navigator.serviceWorker.register('/sw.js', { updateViaCache: 'none' });
      })
      .then(registration => {
        console.log('Service Worker registered with scope:', registration.scope);
        
        // Check for updates immediately
        registration.update().catch(err => 
          console.log('Initial update check failed:', err)
        );
        
        // Set up a periodic update check (every 5 minutes)
        setInterval(() => {
          registration.update().catch(err => 
            console.log('Periodic update check failed:', err)
          );
        }, 5 * 60 * 1000);
        
        // Listen for controller change (when a new service worker takes over)
        let refreshing = false;
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          if (!refreshing) {
            console.log('Controller changed, reloading page...');
            refreshing = true;
            window.location.reload();
          }
        });
        
        // Check if there's a waiting service worker
        if (registration.waiting) {
          console.log('Found waiting service worker, skipping waiting...');
          registration.waiting.postMessage({ type: 'SKIP_WAITING' });
        }
        
        // Listen for new service worker installation
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          console.log('New service worker installing...');
          
          newWorker.addEventListener('statechange', () => {
            console.log('Service worker state changed:', newWorker.state);
            
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              console.log('New update available, prompting user to refresh...');
              if (window.confirm('A new version is available. Refresh now?')) {
                newWorker.postMessage({ type: 'SKIP_WAITING' });
              }
            }
          });
        });
      })
      .catch(error => {
        console.error('Service Worker registration failed:', error);
      });
    }
  </script>
  <script type="module" src="/main.jsx"></script>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100">
  <div id="root"></div>
</body>
</html>